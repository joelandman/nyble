#!/bin/bash -x
#exit 0
. /root/kernel.data

LSB=`lsb_release -a`
lsb_release -a | perl -ane '$_=~s/:\s+(.*?)$/=\"$1\"/g;$_ =~ s/\ ID=/_ID=/g;print ' > lsb.data
. lsb.data
ARCH=x86_64


ZFS_VER=2.1.12
ZFS_NAME=zfs-${ZFS_VER}
ZFS_TAR=${ZFS_NAME}.tar.gz



pushd .
cd /root/x

if [[ -e /etc/debian_release ]]; then
m-a prepare
apt-get install -y libaio-dev libudev-dev libudev0

else

pushd .
cd /lib/modules/${KERNEL_VERSION}/source
make modules_prepare
make headers_install
popd
fi

tar -zxvf ${ZFS_TAR}
cd ${ZFS_NAME}

if (echo ${LSB} | grep -q Debian ); then
./configure --with-linux=/usr/src/linux-source-${KV}
else
./configure
fi
make -j8
make install

popd
