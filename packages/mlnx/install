#!/bin/bash

MLNX_VER=5.0-2.1.8.0
LSB=`lsb_release -a`
lsb_release -a | perl -ane '$_=~s/:\s+(.*?)$/=\"$1\"/g;print' > lsb.data
. lsb.data

KERN=

if [[ -e /etc/redhat-release ]]; then
DIST=rhel$Release
KERN="-k ${KERNEL_VERSION}"
fi

if (echo ${LSB} | grep -q Debian ); then
DIST=debian$Release
KERN="-k ${KERNEL_VERSION} -s /usr/src/linux-headers-${KERNEL_VERSION} --add-kernel-support --skip-distro-check --distro=ubuntu18.04"
fi

if (echo ${LSB} | grep -q Ubuntu ); then
DIST=ubuntu$Release
KERN="-k ${KERNEL_VERSION} -s /usr/src/linux-headers-${KERNEL_VERSION} --add-kernel-support"
fi

ARCH=x86_64

MLNX_NAME=MLNX_OFED_LINUX-${MLNX_VER}-${DIST}-${ARCH}
MLNX_TAR=${MLNX_NAME}.tgz


. /root/kernel.data

pushd .
cd /root/x

tar -zxvf ${MLNX_TAR}
cd ${MLNX_NAME}

if ( cat ${DIST} | grep -q rhel ); then
 yum -y install  pciutils numactl-libs gtk2 atk gcc-gfortran  \
	tcsh openssl-libs expat lsof ethtool libstdc++ python \
	make pkgconfig cairo libnl3 glib2 libmnl tcl tk
fi

./mlnxofedinstall --skip-distro-check --distro ${DIST}  -vvv  ${KERN}  --force --all 




popd






